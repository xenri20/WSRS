@* Reports Page *@

<div id="reports">
    <h2>Reports Chart</h2>

    <!-- Dropdown for selecting violation type -->
    <label for="violationType">Select Violation Type:</label>
    <select id="violationType">
        <option value="MajorViolations">Major Violations</option>
        <option value="MinorViolations">Minor Violations</option>
        <option value="MinorTrafficViolations">Minor Traffic Violations</option>
        <option value="MajorTrafficViolations">Major Traffic Violations</option>
    </select>

    <!-- Date range selection -->
    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">

    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">

    <button id="filterButton">Apply Filter</button>
     
    <h3 id="totalViolations">Total Violations: 0</h3>
    <div style="width: 50vw; height: 500px; margin: auto;">
        <canvas id="reportsChart"></canvas>
    </div>
</div>
<div>
    <button id="generateReportBtn" class="btn btn-primary">Generate Report</button>
</div>
<!-- Modal for Input -->
<div id="exportModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Reports to Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="excelFileName">File Name:</label>
                <input type="text" id="excelFileName" class="form-control" placeholder="Enter file name" required>

                <label for="exportStartDate">Start Date:</label>
                <input type="date" id="exportStartDate" class="form-control">

                <label for="exportEndDate">End Date:</label>
                <input type="date" id="exportEndDate" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="exportExcelBtn">Export</button>
            </div>
        </div>
    </div>
</div>


<script src="/lib/jquery/dist/jquery.min.js"></script>
<script src="/lib/chartjs/dist/chart.umd.js"></script>

<script>
    $(document).ready(function () {
        var chart;
        var collegeColors = {
            "CBAA": "yellow",
            "CCJE": "pink",
            "CEAT": "green",
            "CICS": "gray",
            "CLAC": "white",
            "COED": "blue",
            "COS": "red",
            "CTHM": "purple"
        };

        // Load all data on page load (no date filtering)
        fetchData('MajorViolations', null, null);

        // Apply filter when selecting a violation type
        $('#violationType').change(function () {
            var selectedViolationType = $(this).val();
            fetchData(selectedViolationType, null, null);
        });

        // Apply filter when clicking the button
        $('#filterButton').click(function () {
            var selectedViolationType = $('#violationType').val();
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();

            fetchData(selectedViolationType, startDate, endDate);
        });

        function fetchData(violationType, startDate, endDate) {
            $.ajax({
                type: "POST",
                url: "/Reports/GetCollegeReports",
                data: JSON.stringify({ 
                    violationType: violationType,
                    startDate: startDate || null,
                    endDate: endDate || null
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (response.error) {
                        console.error(response.error);
                        alert("Error loading chart data.");
                        return;
                    }

                    var chartLabels = response.labels;
                    var chartData = response.violationNumbers;
                    var totalViolations = response.totalViolations;

                    $("#totalViolations").text("Total Violations: " + totalViolations);

                    var chartColors = chartLabels.map(function (college) {
                        return collegeColors[college] || "gray"; 
                    });

                    if (chart) {
                        chart.destroy();
                    }

                    chart = new Chart("reportsChart", {
                        type: "bar",
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: violationType + " by College",
                                backgroundColor: chartColors,
                                borderColor: "black",
                                borderWidth: 1,
                                data: chartData
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: violationType + " by College" }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: "Number of Violations" }},
                                x: { title: { display: true, text: "College" }}
                            }
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching data:", error);
                    alert("Failed to load chart data.");
                }
            });
        }
    });
</script>
<script src="/lib/jquery/dist/jquery.min.js"></script>
<script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        // Open Modal on Button Click
        $('#generateReportBtn').click(function () {
            $('#exportModal').modal('show');
        });

        // Handle Export Button Click
        $('#exportExcelBtn').click(function () {
            var fileName = $('#excelFileName').val();
            var startDate = $('#exportStartDate').val();
            var endDate = $('#exportEndDate').val();

            if (!fileName.trim()) {
                alert("Please enter a file name!");
                return;
            }

            var url = `/Reports/ExportToExcel?fileName=${encodeURIComponent(fileName)}&startDate=${startDate}&endDate=${endDate}`;
            window.location.href = url; // Trigger file download
            $('#exportModal').modal('hide');
        });
    });
</script>

